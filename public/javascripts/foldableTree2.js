var json =
{
  "name": "Proceso de Contratación",
  "text":"",
    "children": [
        {
          "name": "Planeación",
          "text":"",
            "children": [
              {
                "name": "Presupuesto",
                "text":"",
                "children": [
                  {"name": "Fuente","text":"Presupuesto de Egresos de la Fedración 2015 y 2016"},
                  {"name": "ID","text":"1409JZL0005"},
                  {"name": "Descripción","text":"Transferencias a fideicomisos públicos"},
                  {"name": "Total","text":"$150,000,000.00"},
                  {"name": "Proyecto presupuestario","text":"Nuevo Aeropuerto Internacional de la Ciudad de México"}
                ]
              },
              {"name":"Fundamento",
               "text":'Los servicios, se contemplan dentro la línea de acción 1.4.1 , correspondiente a la estrategia 1.4 que deriva del objetivo 1 del Programa Sectorial de Comunicaciones y Transportes, que a su vez se enmarca dentro de las líneas de acción del Plan Nacional de Desarrollo en Materia de Aeropuertos, debido a que tales servicios se encuentran implícitos en la estrategia general de modernizar los aeropuertos regionales y ampliar la capacidad de aquellos saturados o  logísticamente prioritarios y en la acción especí'},
              {
                "name": "Documentos",
                "text":"",
                "children": [
                  {"name": "Estudio factibilidad", "text":"Factibilidad técnica, legal y ambiental del proyecto de desarrollo del Nuevo Aeropuerto Internacional de la Ciudad de México"},
                  {"name": "Evaluación necesidades", "text":"Términos de referencia para los servicios del proyecto ejecutivo construcción, equipamiento, mobiliario e instalaciones complementarias para el campamento del Grupo Aeroportuario de la Ciudad de México (GACM) en el sitio del Nuevo Aeropuerto Internacional de la Ciudad de México publicados en CompraNet el 23 de junio de 2015."},
                  {"name": "Estudio mercado", "text":"Investigación de mercado para la contratación relativa al Desarrollo del Proyecto Ejecutivo, construcción, equipamiento de mobiliario en instalaciones complementarias para el campamento del Grupo Aeroportuario de la Ciudad de México en l sitio del Nuevo Aeropuerto Internacional de la Ciudad de México, emitida por la subdirección de Proyectos de la Dirección Corporativa de Infraestructura."}
                ]
              }
            ]
        },
      {
        "name": "Licitación",
        "text":"",
            "children": [
              {"name": "ID","text":"830658"},
              {"name": "Titulo","text":"Desarrollo del proyecto ejecutivo, construcción, equipamiento de mobiliario en   instalaciones complementarias para el campamento del Grupo Aeroportuario   de la Ciudad de México en el sitio del Nuevo Aeropuerto Internacional de la   Ciudad de México."},
              {"name": "Descripción","text":"Desarrollo del Proyecto Ejecutivo, construcción, equipamiento de mobiliario en instalaciones complementarias para el campamento del Grupo Aeroportuario de la Ciudad de México en el sitio del Nuevo Aeropuerto Internacional de la Ciudad de México."},
              {"name": "Estatus","text":"Adjudicado"},
              {"name": "Valor mínimo","text":"No aplica"},
              {"name": "Valor","text":"150,000,000.00"},
              {"name": "Método de adquisición","text":"Licitación Pública",
               "children":[
                 {"name": "Carácter","text":"Nacional"},
                 {"name": "Forma del proceso","text":"Presencial"},
                 {"name":"Fundamento","text":"Artículo 27, segundo párrafo de la Ley de Obras Públicas y Servicios Relacionados con las Mismas"}
               ]},
              {"name": "Item","text":"",
               "children":[
                 {"name":"Clasificación","text":"62501001"},
                 {"name":"Cantidad","text":"1"},
                 {"name":"Unidad","text":"Obra"}
               ]},
              {"name": "Criterio Adjudicación","text":"Puntos y Porcentajes",
               "children":[{"name":"Detalles","text":"Capítulo VII de la Convocatoria (ver anexo)"}]},
              {"name": "Método de recepción","text":"Presencial",
               "children":[{"name":"Detalles","text":"El acto de presentación y apertura de proposiciones se llevó a cabo a las 11:00 horas del 27 de julio de 2015, en la sala de juntas ubicada en Av. Insurgentes Sur 2453, piso 2, Torre Murano, Colonia Tizap&#x00e1;n San Angel, Delegación &#x00c1;lvaro Obregón, México, D.F., C.P. 01090. El acto fue presidido por el Subdirector de Contrataciones de GACM.  Los documentos técnicos T.3, así como la documentación económica E-4, E-5, E-6, E-7, E-8, E-9, E-10, E-11, E-12, E-13, E-14 y E-15, correspondiente a las 17 proposiciones presentadas."}]
              },
              {"name": "Periodo recepción de propuestas","text":"07/27/2015"},
              {"name": "Periodo aclaraciones","text":"",
               "children":[{"name":"inicio","text":"07/02/2015"},
                           {"name":"fin","text":"07/10/2015"}]},
              {"name": "Criterio de elegibilidad","text":"Capítulo VI de la Convocatoria (ver anexo)"},
              {"name": "Periodo adjudicación","text":"07/21/2015"},
              {"name": "Tuvo aclaraciones","text":"343"},
              {"name": "Tuvo testigo social","text":"1"},
              {"name": "Testigo social","text":"",
               "children":[{"name":"ID","text":"AASO390420G79"},
                           {"name":"Nombre","text":"Óscar Álvarez de la Cuadra Sánchez"}]},
              {"name": "Número de participantes","text":"17"},
              {"name": "Entidad que contrata", "text":"Grupo Aeroportuario de la Ciudad de México, S.A. de C.V."},
              {
                "name": "Documents",
                "text":"",
                "children": [
                  {"name": "Aviso de licitación","text":"Proyecto de Convocatoria a la Licitación Pública Nacional Presencial para realizar el desarrollo del proyecto ejecutivo, construcción, equipamiento de, mobiliario e instalaciones complementarias para el campamento del Grupo Aeroportuario De La Ciudad De México (GACM) en el sitio del Nuevo Aeropuerto Internacional de la Ciudad de México (NAICM) publicado en CompraNet el 11 de mayo de 2015"},
                  {"name": "Aviso de audiencia pública","text":"Convocatoria a la Licitación Pública Nacional Presencial LO-009KDH999-N50-2015 para los trabajos relativos a la construcción del drenaje pluvial temporal del Nuevo Aeropuerto Internacional de la Ciudad de México publicada en CompraNet el 23 de junio de 2015"},
                  {"name": "Especificaciones técnicas","text":"Convocatoria a la Licitación Pública Nacional Presencial LO-009KDH999-N50-2015 para los trabajos relativos a la construcción del drenaje pluvial temporal del Nuevo Aeropuerto Internacional de la Ciudad de México publicada en CompraNet el 23 de junio de 2015"},
                  {"name": "Conflictos de interés","text":"Formato de declaración de no conflicto de interés debidamente requisitado y firmado por cada uno de los servidores públicos que participan en el procedimiento de contratación"},
                  {"name": "Inhabilitaciones","text":"Directorio de proveedores y contratistas sancionados de la SFP"},
                  {"name": "Pre-selección de participantes","text":"No aplica para procedimientos realizados bajo la Ley de Obras Públicas y Servicios Relacionados con las Mismas"},
                  {"name": "Criterios evaluación","text":"Convocatoria a la Licitación Pública Nacional Presencial LO-009KDH999-N50-2015 para los trabajos relativos a la construcción del drenaje pluvial temporal del Nuevo Aeropuerto Internacional de la Ciudad de México publicada en CompraNet el 23 de junio de 2015"},
                  {"name": "Información de participantes","text":"Se solicita en la convocatoria el formato para acreditar la presonalidad de los participantes."},
                  {"name": "Criterios de elegibilidad","text":"Convocatoria a la Licitación Pública Nacional Presencial LO-009KDH999-N50-2015 para los trabajos relativos a la construcción del drenaje pluvial temporal del Nuevo Aeropuerto Internacional de la Ciudad de México publicada en CompraNet el 23 de junio de 2015"}
                ]
              },
              {
                "name": "Hitos",
                "text":"",
                "children": [
                  {"name": "Nombre","text":"Visita al sitio de realización de los trabajos para el desarrollo del poryecto ejecutivo, construcción, equipamiento de mobiliario e instalaciones complementarias para el campamenteo de GACM en el sitio del NACM"},
                  {"name":"Descripción","text":"La visita al sitio de realización de los trabajosara el desarrollo del poryecto ejecutivo, construcción, equipamiento de mobiliario e instalaciones complementarias para el campamenteo de GACM en el sitio del NACM  dio inicio a las 10:00 horas del 29 de junio de 2015 en el Km. 75 de la Autopista de Cuota Pe&#x00f1;on - Texcoco en el Centro Mexicano de Capacitación en Agua y Saneamiento y se dio por concluida a las 12:00 horas del mismo día sin que existiera observación alguna por parte de los asistentes."},
                  {"name":"Fecha","text":"06/29/2015"},
                  {"name":"Estatus","text":"Concluido"},
                  {"name":"Documentos soporte", "text":"Acta de visita al sitio de realización de los trabajos publicada en CompraNet el 29 de junio de 2015"}
                ]
              },
              {
                "name": "Modificaciones",
                "text":"No hubo modificaciones"
              }
            ]
      },
      {
        "name": "Adjudicación",
        "text":"",
        "children": [
          {"name": "ID licitación","text":"830658"},
          {"name": "ID adjudicación","text":"LO-009KDH999- N47-2015"},
          {"name": "Título","text":"Acta de emisión de fallo"},
          {"name": "Descripción","text":"Con fundamento en lo dispuesto en el artículo 39, fracción III de la LOPSRM, se adjudica el contrato al consorcio integrado por Acciones Grupo Oro, S.A. de C.V. y Constructora Grupo de Oro, S.A. de C.V. , por un importe de $112,046,320.57, monto sin considerar el IVA, por resultar se la propuesta que al ser evaluada técnica y ecómicamente, obtuvo el puntaje más alto acorde al mecanismo de evaluación previsto en la convocatoria."},
          {"name": "Estatus","text":"Adjudicado"},
          {"name": "Fecha","text":"08/28/2015"},
          {"name": "Valor","text":"112046320.57"},
          {"name": "Inconformidades recibidas","text":"0"},
          {
            "name": "Proveedores",
            "text":"",
            "children": [
              {"name": "ID adjudicación","text":"LO-009KDH999- N47-2015"},
              {"name": "ID proveedor","text":"1. Acciones Grupo Oro, S.A. de C.V.  AGO090512QT4 2.Constructora Grupo de Oro, S.A. de C.V. CGO060731P72"},
              {"name": "Nombre","text":"1. Acciones Grupo Oro, S.A. de C.V.  2.Constructora Grupo de Oro, S.A. de C.V."},
              {"name": "Dirección","text":"",
               "children":[
                 {"name":"Calle","text":"Prolongación 18 de marzo 300"},
                 {"name":"Colonia","text":"Ex Hacienda da La Huerta"},
                 {"name":"Municipio","text":"Morelia"},
                 {"name":"Entidad","text":"Michoacán"},
                 {"name":"País","text":"México"},
                 {"name":"Código postal","text":"58080"},
               ]},
              {"name": "Contacto","text":"Ricardo Ramos Acosta"}
                    ]
          },
          {
            "name": "Documentos",
            "text":"",
            "children": [
              {"name": "ID adjudicación","text":"LO-009KDH999-N50-2015"},
              {"name": "Reportes de evaluación","text":"Acta de Emisión de Fallo"},
              {"name": "Propuesta ganadora","text":"Propuesta técnica y económica del Consorcio integrado por las empresas Calzada Construcciones, S. A. de C. V. y Construcciones y Dragados del Sureste, S. A. de C. V."},
              {"name": "Inconformidades","text":"No se presentaron inconformidades sobre el procedimiento de contratación"}
                    ]
          },
          {"name":"item","text":"",
           "children":[
             {"name":"ID adjudicación","text":"LO-009KDH999- N47-2015"},
             {"name":"ID item","text":"62501001"},
             {"name":"Descripción","text":"Construcción aeropista"},
             {"name":"Clasificación","text":"Obra pública"},
             {"name":"Unidad item","text":"Obra"}
           ]
          },
          {
            "name": "Modificaciones",
            "text":"No hubo modificaciones"
          }
        ]
      },
      {
        "name": "Contratación",
        "text":"",
        "children": [
          {"name": "ID adjudicación","text":"LO-009KDH999-N50-2015"},
          {"name": "ID contrato","text":"LPN-OP-DCAGI-SC-076/15"},
          {"name": "Título","text":"Para los trabajos relativos a la construcción del drenaje pluvial temporal"},
          {"name": "Descripción","text":"Construcción de tres drenes principales, tres canales existentes (parcialmente), tres plantas de bombeo, dos lagunas de regulación, veintidós alcantarilla y dos salidas al Dren General del Valle, al poniente del predio. Rehabilitación de caminos de acceso y puentes alcantarilla para permitir el paso de vehículos de una margen del dren a la margen opuesta."},
          {"name": "Estatus","text":"Activo"},
          {"name": "Periodo","text":"","children":[
            {"name":"Inicio","text":"10/09/2015"},
            {"name":"Fin","text":"03/07/2016"}
          ]},
          {"name": "Valor","text":"192525597.09"},
          {"name": "Fecha de firma","text":"10/09/2015"},
          {
            "name": "items",
            "text":"",
            "children": [
             {"name":"ID contrato","text":"LPN-OP-DCAGI-SC-066/15"},
             {"name":"ID item","text":"62501001"},
             {"name":"Descripción","text":"Construcción aeropista"},
             {"name":"Clasificación","text":"Obra pública"},
             {"name":"Unidad item","text":"Obra"}
            ]
          },
          {
            "name": "Documentos",
            "text":"",
            "children": [
              {"name": "Contrato firmado","text":""},
              {"name": "Cláusulas","text":""},
              {"name": "Cronograma del contrato","text":""},
              {"name": "Anexos del contrato","text":""},
              {"name": "Subcontratos","text":""},
              {"name": "Garantías","text":""}
            ]
          },
          {
            "name": "Modificaciones",
            "text":"No se ha celebrado ningún convenio modificatorio"
          }
        ]
      },
      {
        "name": "Implementación",
        "text":"",
        "children": [
          {
            "name": "Transacción",
            "text":"",
            "children": [
              {"name": "ID adjudicación","text":"LO-009KDH999- N47-2015"},
              {"name": "ID contrato","text":"LPN-OP-DCAGI-SC-066/15"},
              {"name": "ID transacción","text":"1188539"},
              {"name": "Fuente","text":"Fideicomiso para el desarrollo del Nuevo Aeropuerto Internacional de la Ciudad de México"},
              {"name": "Fecha","text":"10/22/2015"},
              {"name": "Monto","text":"10000000.01"},
              {"name": "Emisor","text":"Nacional Financiera, Sociedad Nacional de Crédito, Institución de Banca de Desarrollo, como fiduciaria del Fideicomiso para el desarrollo del NAICM"},
              {"name": "Receptor","text":"Consorcio integrado por las empresas Acciones Grupo de Oro, S.A. de C.V. y Constructora Grupo de Oro, S.A. de C.V."}
            ]
          },
          {
            "name": "Documentos",
            "text":"",
            "children": [
              {"name": "Avance físico","text":"17.5%"},
              {"name": "Avance financiero","text":"10%"},
              {"name": "Certificado de terminación","text":"El contrato continúa en ejecución"},
              {"name": "Auditoría final","text":""}
            ]
          },
          {
            "name": "Hitos",
            "text":"No se han recibido estimaciones por parte del contratista."
          }

        ]
      }
    ]
};


var width = 1200;
var height = 650;
var maxLabel = 150;
var duration = 500;
var radius = 5;

// Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = 1500 - margin.left - margin.right,
    height = 670 - margin.top - margin.bottom;

var i = 0;
var root;

var tree = d3.layout.tree()
    .size([height, width]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var svg = d3.select("#arbol").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(" + maxLabel + ",0)");

root    = json;
root.x0 = height / 2;
root.y0 = 0;

root.children.forEach(collapse);

// Define the div for the tooltip
var div = d3.select("#arbol").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

var barCircles = [
  {"x_axis":100, "y_axis":30,  "radius":20, "color": "#00cc99"},
  {"x_axis":100, "y_axis":60,  "radius":20, "color": "#00cc99"},
  {"x_axis":100, "y_axis":90,  "radius":20, "color": "#00cc99"},
  {"x_axis":100, "y_axis":120, "radius":20, "color": "#00cc99"},
  {"x_axis":100, "y_axis":150, "radius":20, "color": "#00cc99"},
  {"x_axis":100, "y_axis":180, "radius":20, "color": "#00cc99"}
];

var svgContainer = d3.select("body").append("svg")
      .attr("width", 200)
      .attr("height", 200);

var circles = svgContainer.selectAll("circle")
      .data(barCircles)
      .enter()
      .append("circle");

var circleAttributes = circles
      .attr("cx", function (d) { return d.x_axis; })
      .attr("cy", function (d) { return d.y_axis; })
      .attr("r", function (d) { return d.radius; })
      .style("fill", function(d) { return d.color; });

function update(source)
{
    // Compute the new tree layout.
    var nodes = tree.nodes(root).reverse();
    var links = tree.links(nodes);

    // Normalize for fixed-depth.
    nodes.forEach(function(d) { d.y = d.depth * maxLabel; });

    // Update the nodes…
    var node = svg.selectAll("g.node")
        .data(nodes, function(d){
            return d.id || (d.id = ++i);
        });

    // Enter any new nodes at the parent's previous position.
    var nodeEnter = node.enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", function(d){ return "translate(" + source.y0 + "," + source.x0 + ")"; })
        .on("click", click)
        .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", d.text.length>0?.9:0);
            div.html(d.text)
                .style("left", (d3.event.pageX) + "px")
                .style("top",  (d3.event.pageY - 10) + "px")
                .style("width",   /*d.text.length*10  + "px"*/ 300 + "px")
                .style("height",  /*d.text.length*10  + "px"*/ "auto");
        })
        .on("mouseout", function(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);
        })
        .on("mouseover", function(d){
        d3.select(this).attr("r", "10");
      });

    nodeEnter.append("circle")
        .attr("r", 0)
        .style("fill", function(d){
            return d._children ? "white" : "#00cc99";
        })
        .style("stroke", function(d){
            return d._children ? "#9E9E9E" : "#00cc99";
        });

    nodeEnter.append("text")
        .attr("x", function(d){
            var spacing = computeRadius(d) + 5;
            return d.children || d._children ? -spacing : spacing;
        })
        .attr("dy", "3")
        .attr("text-anchor", function(d){ return d.children || d._children ? "end" : "start"; })
        .text(function(d){ return d.name; })
        .style("fill-opacity", 0);


    // Transition nodes to their new position.
    var nodeUpdate = node.transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

    nodeUpdate.select("circle")
        .attr("r", function(d){ return computeRadius(d); })
        .style("fill", function(d) { return d._children ? "white" : "#00cc99"; })
        .style("stroke", function(d){
            return d._children ? "#9E9E9E" : "#00cc99";
        });

    nodeUpdate.select("text").style("fill-opacity", 1);

    // Transition exiting nodes to the parent's new position.
    var nodeExit = node.exit().transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
        .remove();

    nodeExit.select("circle").attr("r", 0);
    nodeExit.select("text").style("fill-opacity", 0);

    // Update the links…
    var link = svg.selectAll("path.link")
        .data(links, function(d){ return d.target.id; })
        .on("click", function(d) {
            d.style("stroke", function(d){ return d.children || d._children ? "#9E9E9E" : "#00cc99"; });
        });


    // Enter any new links at the parent's previous position.
    link.enter().insert("path", "g")
        .attr("class", "link")
        .attr("d", function(d){
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
        });

    // Transition links to their new position.
    link.transition()
        .duration(duration)
        .attr("d", diagonal);


    // Transition exiting nodes to the parent's new position.
    link.exit().transition()
        .duration(duration)
        .attr("d", function(d){
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
        })
        .remove();

    // Stash the old positions for transition.
    nodes.forEach(function(d){
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

function computeRadius(d)
{
    if(d.children || d._children) return radius + (radius * nbEndNodes(d) / 10);
    else return radius;
}

function nbEndNodes(n)
{
    nb = 0;
    if(n.children){
        n.children.forEach(function(c){
            nb += nbEndNodes(c);
        });
    }
    else if(n._children){
        n._children.forEach(function(c){
            nb += nbEndNodes(c);
        });
    }
    else nb++;

    return nb;
}

function click(d)
{
    if (d.children){
        d._children = d.children;
        d.children = null;
    }
    else{
        d.children = d._children;
        d._children = null;
    }
    update(d);
}

function collapse(d){
    if (d.children){
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

update(root);

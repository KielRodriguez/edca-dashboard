var json =
{
    "name": "Proceso de Contratación",
    "text":"",
    "children": [
        {
            "name": "Planeación",
            "text":"",
            "children": [
                {
                    "name": "Presupuesto",
                    "text":"",
                    "children": [
                        {"name": "Fuente","text":"Presupuesto de Egresos de la Fedración 2015 y 2016"},
                        {"name": "ID","text":"1409JZL0005"},
                        {"name": "Descripción","text":"Transferencias a fideicomisos públicos"},
                        {"name": "Total","text":"$490,000,000.00"},
                        {"name": "Proyecto presupuestario","text":"Nuevo Aeropuerto Internacional de la Ciudad de México"}
                    ]
                },
                {"name":"Fundamento",
                    "text":'Dado que las precipitaciones locales escurrierón hacia las zonas más bajas del polígono, lo que antiguamente fuera el lago de Texcoco, durante la construcción del NAICM se requeririó; un drenaje pluvial provisional de funcionamiento temporal dentro del perímetro de la construcción, que permita asegurar la protección de dichas obras. Lo anterior, con el objetivo de asegurar que las zonas donde se esté desarrollando los trabajos permanezcan secas.'},
                {
                    "name": "Documentos",
                    "text":"",
                    "children": [
                        {"name": "Estudio factibilidad", "text":"Factibilidad técnica, legal y ambiental del proyecto de desarrollo del Nuevo Aeropuerto Internacional de la Ciudad de México"},
                        {"name": "Evaluación necesidades", "text":"Términos de referencia para la construcción del drenaje pluvial temporal para la protección de la zona durante la construcción de la primera fase del NAICM publicados en CompraNet el 24 de junio de 2015"},
                        {"name": "Estudio mercado", "text":"No aplica"}
                    ]
                }
            ]
        },
        {
            "name": "Licitación",
            "text":"",
            "children": [
                {"name": "ID","text":"LPN-OP-DCAGI-SC-076/15"},
                {"name": "Titulo","text":""},
                {"name": "Descripción","text":""},
                {"name": "Estatus","text":""},
                {"name": "Valor mínimo","text":""},
                {"name": "Valor","text":""},
                {"name": "Método de adquisición","text":"",
                    "children":[
                        {"name":"Fundamento","text":""}
                    ]},
                {"name": "Items","text":"",
                    "children":[
                        {"name":"","text":""}
                    ]},
                {"name": "Criterio Adjudicación","text":""},
                {"name": "Método de recepción","text":""},
                {"name": "Periodo recepción de propuestas","text":""},
                {"name": "Periodo aclaraciones","text":""},
                {"name": "Criterio de elegibilidad","text":""},
                {"name": "Número de participantes","text":""},
                {
                    "name": "Entidad que contrata",
                    "text":"",
                    "children": [
                        {"name": "Id","text":""},
                        {"name": "Nombre","text":""}
                    ]
                },
                {
                    "name": "Documents",
                    "text":"",
                    "children": [
                        {"name": "Aviso de licitación","text":""},
                        {"name": "Aviso de audiencia pública","text":""},
                        {"name": "Especificaciones técnicas","text":""},
                        {"name": "Conflictos de interés","text":""},
                        {"name": "Inhabilitaciones","text":""},
                        {"name": "Pre-selección de participantes","text":""},
                        {"name": "Información de participantes","text":""},
                        {"name": "Criterios de elegibilidad","text":""}
                    ]
                },
                {
                    "name": "Hitos",
                    "text":"",
                    "children": [
                        {"name": "Id","text":""},
                        {"name": "Nombre","text":""}
                    ]
                },
                {
                    "name": "Modificaciones",
                    "text":"",
                    "children": [
                        {"name": "Id","text":""},
                        {"name": "Nombre","text":""}
                    ]
                }
            ]
        },
        {
            "name": "Adjudicación",
            "text":"",
            "children": [
                {"name": "ID","text":""},
                {"name": "Título","text":""},
                {"name": "Descripción","text":""},
                {"name": "Estatus","text":""},
                {"name": "Fecha","text":""},
                {"name": "Valor","text":""},
                {
                    "name": "Proveedores",
                    "text":"",
                    "children": [
                        {"name": "Child 1","text":""},
                        {"name": "Child 2","text":""},
                        {"name": "Child 3","text":""}
                    ]
                },
                {
                    "name": "Documentos",
                    "text":"",
                    "children": [
                        {"name": "Child 1","text":""},
                        {"name": "Child 2","text":""},
                        {"name": "Child 3","text":""}
                    ]
                },
                {
                    "name": "Modificaciones",
                    "text":"",
                    "children": [
                        {"name": "Child 1","text":""},
                        {"name": "Child 2","text":""},
                        {"name": "Child 3","text":""}
                    ]
                }
            ]
        },
        {
            "name": "Contratación",
            "text":"",
            "children": [
                {"name": "ID","text":""},
                {"name": "ID adjudicación","text":""},
                {"name": "Título","text":""},
                {"name": "Descripción","text":""},
                {"name": "Estatus","text":""},
                {"name": "Periodo","text":""},
                {"name": "Valor","text":""},
                {"name": "Fecha de firma","text":""},
                {
                    "name": "items",
                    "text":"",
                    "children": [
                        {"name": "Child 1","text":""}
                    ]
                },
                {
                    "name": "Documentos",
                    "text":"",
                    "children": [
                        {"name": "Contrato firmado","text":""},
                        {"name": "Cláusulas","text":""},
                        {"name": "Cronograma del contrato","text":""},
                        {"name": "Anexos del contrato","text":""},
                        {"name": "Subcontratos","text":""},
                        {"name": "Garantías","text":""}
                    ]
                },
                {
                    "name": "Modificaciones",
                    "text":"",
                    "children": [
                        {"name": "Garantías","text":""}
                    ]
                }
            ]
        },
        {
            "name": "Implementación",
            "text":"",
            "children": [
                {
                    "name": "Transacción",
                    "text":"",
                    "children": [
                        {"name": "ID","text":""},
                        {"name": "Fuente","text":""},
                        {"name": "Fecha","text":""},
                        {"name": "Cantidad","text":""},
                        {"name": "Emisor","text":""},
                        {"name": "Receptor","text":""}
                    ]
                },
                {
                    "name": "Documentos",
                    "text":"",
                    "children": [
                        {"name": "Avance físico","text":""},
                        {"name": "Avance financiero","text":""},
                        {"name": "Certificado de terminación","text":""},
                        {"name": "Auditoría final","text":""}
                    ]
                },
                {
                    "name": "Hitos",
                    "text":"",
                    "children": [
                        {"name": "Child 3","text":""}
                    ]
                }

            ]
        }
    ]
};

var width = 1200;
var height = 650;
var maxLabel = 150;
var duration = 500;
var radius = 5;

// Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = 1500 - margin.left - margin.right,
    height = 670 - margin.top - margin.bottom;

var i = 0;
var root;

var tree = d3.layout.tree()
    .size([height, width]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var svg = d3.select("#arbol").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(" + maxLabel + ",0)");

root    = json;
root.x0 = height / 2;
root.y0 = 0;

root.children.forEach(collapse);

// Define the div for the tooltip
var div = d3.select("#arbol").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

function update(source)
{
    // Compute the new tree layout.
    var nodes = tree.nodes(root).reverse();
    var links = tree.links(nodes);

    // Normalize for fixed-depth.
    nodes.forEach(function(d) { d.y = d.depth * maxLabel; });

    // Update the nodes…
    var node = svg.selectAll("g.node")
        .data(nodes, function(d){
            return d.id || (d.id = ++i);
        });

    // Enter any new nodes at the parent's previous position.
    var nodeEnter = node.enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", function(d){ return "translate(" + source.y0 + "," + source.x0 + ")"; })
        .on("click", click)
        .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", d.text.length>0?.9:0);
            div.html(d.text)
                .style("left", (d3.event.pageX) + "px")
                .style("top",  (d3.event.pageY - 10) + "px")
                .style("width",   /*d.text.length*10  + "px"*/ 300 + "px")
                .style("height",  /*d.text.length*10  + "px"*/ "auto");
        })
        .on("mouseout", function(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);
        });

    nodeEnter.append("circle")
        .attr("r", 0)
        .style("fill", function(d){
            return d._children ? "white" : "#00cc99";
        })
        .style("stroke", function(d){
            return d._children ? "#9E9E9E" : "#00cc99";
        });

    nodeEnter.append("text")
        .attr("x", function(d){
            var spacing = computeRadius(d) + 5;
            return d.children || d._children ? -spacing : spacing;
        })
        .attr("dy", "3")
        .attr("text-anchor", function(d){ return d.children || d._children ? "end" : "start"; })
        .text(function(d){ return d.name; })
        .style("fill-opacity", 0);


    // Transition nodes to their new position.
    var nodeUpdate = node.transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

    nodeUpdate.select("circle")
        .attr("r", function(d){ return computeRadius(d); })
        .style("fill", function(d) { return d._children ? "white" : "#00cc99"; })
        .style("stroke", function(d){
            return d._children ? "#9E9E9E" : "#00cc99";
        });

    nodeUpdate.select("text").style("fill-opacity", 1);

    // Transition exiting nodes to the parent's new position.
    var nodeExit = node.exit().transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
        .remove();

    nodeExit.select("circle").attr("r", 0);
    nodeExit.select("text").style("fill-opacity", 0);

    // Update the links…
    var link = svg.selectAll("path.link")
        .data(links, function(d){ return d.target.id; })
        .on("click", function(d) {
            d.style("stroke", function(d){ return d.children || d._children ? "#9E9E9E" : "#00cc99"; });
        });


    // Enter any new links at the parent's previous position.
    link.enter().insert("path", "g")
        .attr("class", "link")
        .attr("d", function(d){
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
        });

    // Transition links to their new position.
    link.transition()
        .duration(duration)
        .attr("d", diagonal);


    // Transition exiting nodes to the parent's new position.
    link.exit().transition()
        .duration(duration)
        .attr("d", function(d){
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
        })
        .remove();

    // Stash the old positions for transition.
    nodes.forEach(function(d){
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

function computeRadius(d)
{
    if(d.children || d._children) return radius + (radius * nbEndNodes(d) / 10);
    else return radius;
}

function nbEndNodes(n)
{
    nb = 0;
    if(n.children){
        n.children.forEach(function(c){
            nb += nbEndNodes(c);
        });
    }
    else if(n._children){
        n._children.forEach(function(c){
            nb += nbEndNodes(c);
        });
    }
    else nb++;

    return nb;
}

function click(d)
{
    if (d.children){
        d._children = d.children;
        d.children = null;
    }
    else{
        d.children = d._children;
        d._children = null;
    }
    update(d);
}

function collapse(d){
    if (d.children){
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

update(root);
